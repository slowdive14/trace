---
type: troubleshooting
status: done
description: "수면 주간 비교에서 지난 주 점수가 실제와 다르게 표시되는 버그"
created: 2026-02-01
modified: 2026-02-01
phase: resolved
---

# 문제
> 이번 주 수면 화면에서 "지난 주 62점"으로 표시되지만, 실제 지난 주 화면에서는 "50점"으로 표시됨. 50점이 실제 값이고 62점은 잘못된 계산.

---

# 시도
- 주간 비교 로직 분석 (`SleepStats.tsx`, `sleepUtils.ts`)
- `calculateSleepScore` 함수의 `contextRecords` 파라미터 사용 패턴 확인

---

# 원인
- `calculateSleepScore(records, contextRecords)` 함수는 일관성 점수 계산 시 `contextRecords`를 포함하여 계산
- **이번 주 점수**: `calculateSleepScore(currentWeekData, prevWeekData)` → 지난 주 데이터를 context로 포함
- **지난 주 점수**: `calculateSleepScore(prevWeekData)` → context 없이 계산 (빈 배열)
- 동일한 주의 점수가 보는 시점에 따라 다르게 계산됨

---

# 해결
- `prevWeekScore` 계산 시에도 `prevPrevWeekData`를 contextRecords로 전달
- `SleepStats.tsx`와 `sleepUtils.ts`의 `compareWeeks` 함수 모두 수정

```typescript
// Before
const prevWeekScore = calculateSleepScore(prevWeekData.records);

// After
const prevPrevWeekData = getWeeklyRecords(allRecords, weekOffset + 2);
const prevWeekScore = calculateSleepScore(prevWeekData.records, prevPrevWeekData.records);
```

---

# 관련 파일
- C:/Users/user/Downloads/trace/src/components/SleepStats.tsx
- C:/Users/user/Downloads/trace/src/utils/sleepUtils.ts

---

# 재발 방지
- 점수 계산 함수 호출 시 context 데이터 일관성 유지
- 동일한 데이터에 대해 다른 시점에서도 같은 결과가 나오는지 테스트

---

# 📝 쉬운 설명

### 문제
이번 주 화면에서 보는 "지난 주 점수"와 실제 지난 주 화면에서 보는 "이번 주 점수"가 달랐음 (62점 vs 50점)

### 원인
수면 점수 계산 시 "일관성"을 측정하려면 이전 주 데이터도 참고해야 하는데, 지난 주 점수를 계산할 때는 그 이전 주 데이터를 빠뜨림. 마치 시험 점수 평균을 낼 때 일부 과목을 빼먹은 것과 같음.

### 해결
지난 주 점수 계산할 때도 그 이전 주(2주 전) 데이터를 함께 참고하도록 수정

### 관련 파일
- C:/Users/user/Downloads/trace/src/components/SleepStats.tsx
- C:/Users/user/Downloads/trace/src/utils/sleepUtils.ts
